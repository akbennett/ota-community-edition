apiVersion: v1
data:
  gateway.conf: |-
    server {
      error_log  /var/log/nginx/error.log debug;
      listen       8443 ssl;
      server_name ota.ce;
      ssl_certificate     /etc/ssl/gateway/server.chain.pem;
      ssl_certificate_key /etc/ssl/gateway/server.key;
      ssl_verify_client on;
      ssl_verify_depth 10;
      ssl_client_certificate /etc/ssl/gateway/ca.crt;

      if ($ssl_client_s_dn ~ "CN=(.*)$") {
        set $deviceUuid $1;
      }
      if ($ssl_client_s_dn !~ "CN=(.*)$") {
        set $deviceUuid $ssl_client_s_dn;
      }
      set $deviceNamespace "default";

      location /core/ {
        rewrite ^/core/(.*)$ /api/v1/mydevice/${deviceUuid}/$1 break;
        proxy_set_header x-ats-namespace $deviceNamespace;
        proxy_pass http://core;
      }

      location /treehub/ {
        rewrite ^/treehub/(.*)$ /api/v2/$1 break;
        proxy_set_header x-ats-device-uuid $deviceUuid;
        proxy_set_header x-ats-namespace $deviceNamespace;
        proxy_pass http://treehub;
      }

      location /director/ {
        rewrite ^/director/(.*)$ /api/v1/device/${deviceUuid}/$1 break;
        proxy_set_header x-ats-namespace $deviceNamespace;
        proxy_pass http://director;
      }

      location /repo/ {
        rewrite ^/repo/(.*)$ /api/v1/user_repo/${deviceUuid}/$1 break;
        proxy_set_header x-ats-namespace $deviceNamespace;
        proxy_pass http://repo;
      }

    }
  upstreams.conf: |-
    upstream core {
      server sota-core:80;
    }

    upstream treehub {
      server treehub:80;
    }

    upstream director {
      server director:80;
    }

    upstream repo {
      server tuf-reposerver:80;
    }
kind: ConfigMap
metadata:
  creationTimestamp: 2017-12-20T15:46:34Z
  name: gateway-config
  namespace: default
  selfLink: /api/v1/namespaces/default/configmaps/gateway-config
---
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: gateway-deployment
spec:
  selector:
    matchLabels:
      app: gateway
  replicas: 1
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
      - name: nginx
        image: nginx:1.13.7
        command:
        - nginx-debug
        - -g
        - 'daemon off;'
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/
        - name: gateway-tls
          mountPath: /etc/ssl/gateway/
          readOnly: true
        ports:
        - containerPort: 80
        - containerPort: 8443
      volumes:
      - name: nginx-config
        configMap:
          name: gateway-config
      - name: gateway-tls
        secret:
          secretName: gateway-tls
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
spec:
  ports:
     - name: http
       port: 80
       protocol: TCP
       targetPort: 80
     - name: https
       port: 8443
       protocol: TCP
       targetPort: 8443
       nodePort: 30443
  selector:
    app: gateway
  type: NodePort
